<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Restaurant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:0;padding:1rem;background:#f5f7fa;color:#333}
    h1{text-align:center;margin-top:0}
    #status{margin-bottom:.5rem;font-weight:500}
    .controls{display:flex;flex-wrap:wrap;gap:.7rem;margin-bottom:1rem;background:#fff;padding:1rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .controls label{display:flex;flex-direction:column;font-size:.9rem}
    .controls input,.controls select{padding:.4rem;border:1px solid #bbb;border-radius:4px}
    #stats{margin-bottom:.5rem;font-weight:500}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    th,td{padding:.6rem;text-align:left}
    th{background:#1976d2;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    a{color:#1976d2;text-decoration:none}
    a:hover{text-decoration:underline}
    @media(max-width:700px){body{padding:.5rem} .controls{flex-direction:column}}
  </style>
</head>
<body>
  <h1>Restaurant Dashboard</h1>
  <div id="status">Loading data…</div>

  <div class="controls">
    <label>Restaurant  <select id="restFilter"><option>All</option></select></label>
    <label>Year        <select id="yearFilter"><option>All</option></select></label>
    <label>Avg spend ≥  <input type="number" id="avgMin" step="0.01" placeholder="0"></label>
    <label>Avg spend ≤  <input type="number" id="avgMax" step="0.01"></label>
    <label>Total spend ≥  <input type="number" id="totMin" step="0.01" placeholder="0"></label>
    <label>Total spend ≤  <input type="number" id="totMax" step="0.01"></label>
    <label>Days since last order ≥  <input type="number" id="lastMin" placeholder="0"></label>
    <label>Days since last order ≤  <input type="number" id="lastMax"></label>
    <label>Orders ≥  <input type="number" id="ordMin" placeholder="0"></label>
    <label>Orders ≤  <input type="number" id="ordMax"></label>
    <label><input type="checkbox" id="lostOnly"> Lost customers only (90+ days)</label>
    <label>Complaint
      <select id="complaintKeyword">
        <option value="">All</option>
        <option value="call center">call center</option>
        <option value="delay">delay</option>
        <option value="delivery">delivery</option>
        <option value="food safety and poisoning">food safety and poisoning</option>
        <option value="food temperature">food temperature</option>
        <option value="missing items">missing items</option>
        <option value="other complaints">other complaints</option>
        <option value="packaging">packaging</option>
        <option value="portion">portion</option>
        <option value="quality of food">quality of food</option>
      </select>
    </label>
  </div>

  <div id="stats"></div>

  <table id="mainTable">
    <thead>
      <tr>
        <th>Phone</th><th>Account Name</th><th>Orders</th><th>Total</th><th>Avg</th><th>Last order</th><th>Days ago</th><th>Complaints</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/* ----------  CONFIG  ---------- */
const COL_PHONE = 'Account Phones';
const COL_NAME  = 'Account Name';
const COL_TOTAL = 'Total Price';
const COL_DATE  = 'Created';
const COL_REST  = 'Resturant';

let rawRows    = [];
let aggData    = [];
let complaints = [];
const today    = new Date();

/* ----------  LOAD + NORMALISE + DEBUG  ---------- */
Promise.all([
  fetch('data.json').then(r => r.json()),
  fetch('complaints.json').then(r => r.json())
])
.then(([dataRows, compRows]) => {
  /* --- normalise phones --- */
  rawRows    = dataRows.map(r => ({...r, [COL_PHONE]: (r[COL_PHONE] || '').toString().trim()}));
  complaints = compRows.map(c => ({...c, phone: (c.phone || '').toString().trim()}));

  /* --- DEBUG: print first 5 phones each side --- */
  console.log('data phones  :', [...new Set(rawRows.map(r=>r[COL_PHONE]))].slice(0,5));
  console.log('compl phones :', [...new Set(complaints.map(c=>c.phone))].slice(0,5));

  aggregate();
  populateDropdowns();
  applyFilters();
  setStatus('Ready.', 'green');
})
.catch(err => {
  console.error(err);
  setStatus('Error loading JSON files', 'red');
});

/* ----------  STATUS  ---------- */
function setStatus(msg, color = 'black') {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = color;
}

/* ----------  AGGREGATE  ---------- */
function aggregate() {
  const map = {};
  rawRows.forEach(r => {
    const phone = r[COL_PHONE];
    if (!phone) return;
    if (!map[phone]) map[phone] = { phone, name: r[COL_NAME] || '—', orders: [], total: 0 };
    const amt  = parseFloat(r[COL_TOTAL]) || 0;
    const date = new Date(r[COL_DATE] || '');
    const rest = r[COL_REST] || r['Restaurant'] || '';
    map[phone].orders.push({ date, value: amt, rest });
    map[phone].total += amt;
  });

  aggData = Object.values(map).map(x => {
    x.orders.sort((a, b) => a.date - b.date);
    const last = x.orders[x.orders.length - 1].date;
    const days = Math.floor((today - last) / 864e5);
    const compCount = complaints.filter(c => c.phone === x.phone).length;
    return {
      phone: x.phone,
      name: x.name,
      orders: x.orders.length,
      totalSpent: x.total,
      avgSpent: x.total / x.orders.length,
      lastOrder: last,
      daysAgo: days,
      year: last.getFullYear(),
      orderList: x.orders,
      complaintCount: compCount
    };
  });
}

/* ----------  DROPDOWNS  ---------- */
function populateDropdowns() {
  const rests = ['All', ...new Set(rawRows.map(r => r[COL_REST] || r['Restaurant'] || '').filter(Boolean))].sort();
  const years = ['All', ...new Set(aggData.map(x => x.year))].sort((a, b) => b - a);
  document.getElementById('restFilter').innerHTML = rests.map(r => `<option>${r}</option>`).join('');
  document.getElementById('yearFilter').innerHTML = years.map(y => `<option>${y}</option>`).join('');
}

/* ----------  LIVE FILTERS  ---------- */
['restFilter','yearFilter','avgMin','avgMax','totMin','totMax','lastMin','lastMax','ordMin','ordMax','lostOnly','complaintKeyword']
  .forEach(id => document.getElementById(id).addEventListener('input', applyFilters));

function applyFilters() {
  const restSel  = document.getElementById('restFilter').value;
  const yearSel  = document.getElementById('yearFilter').value;
  const avgMin   = parseFloat(document.getElementById('avgMin').value) || 0;
  const avgMax   = parseFloat(document.getElementById('avgMax').value) || Infinity;
  const totMin   = parseFloat(document.getElementById('totMin').value) || 0;
  const totMax   = parseFloat(document.getElementById('totMax').value) || Infinity;
  const lastMin  = parseInt(document.getElementById('lastMin').value) || 0;
  const lastMax  = parseInt(document.getElementById('lastMax').value) || Infinity;
  const ordMin   = parseInt(document.getElementById('ordMin').value) || 0;
  const ordMax   = parseInt(document.getElementById('ordMax').value) || Infinity;
  const lostOnly = document.getElementById('lostOnly').checked;
  const keyword  = document.getElementById('complaintKeyword').value.trim().toLowerCase();

  let list = aggData.filter(x =>
    (restSel === 'All' || x.orderList.some(o => o.rest === restSel)) &&
    (yearSel === 'All' || x.year === parseInt(yearSel)) &&
    x.avgSpent >= avgMin && x.avgSpent <= avgMax &&
    x.totalSpent >= totMin && x.totalSpent <= totMax &&
    x.daysAgo >= lastMin && x.daysAgo <= lastMax &&
    x.orders >= ordMin && x.orders <= ordMax &&
    (!lostOnly || x.daysAgo > 90) &&
    (!keyword || complaints.some(c => c.phone === x.phone && (
      (c.details   || '').toLowerCase().includes(keyword) ||
      (c.category  || '').toLowerCase().includes(keyword)
    )))
  );
  list.sort((a, b) => b.orders - a.orders);
  drawTable(list);
}

function drawTable(data) {
  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="details.html?phone=${encodeURIComponent(r.phone)}" target="_blank">${r.phone}</a></td>
      <td>${r.name}</td>
      <td>${r.orders}</td>
      <td>${r.totalSpent.toFixed(2)}</td>
      <td>${r.avgSpent.toFixed(2)}</td>
      <td>${r.lastOrder.toLocaleDateString()}</td>
      <td>${r.daysAgo}</td>
      <td>${r.complaintCount > 0 ? `<a href="complaints.html?phone=${encodeURIComponent(r.phone)}" target="_blank">${r.complaintCount}</a>` : 0}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('stats').textContent = `Showing ${data.length} phones`;
}
</script>
</body>
</html>
