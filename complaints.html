<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Complaint Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ... (keep all the same CSS styles) ... */
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
    <h1>Complaint Details</h1>
  </div>

  <div id="customerInfo" class="customer-info">
    <div class="loading">Loading customer information...</div>
  </div>

  <div id="debugInfo" style="display: none;"></div>

  <div class="complaints-container" id="complaintsList">
    <div class="loading">Loading complaints...</div>
  </div>

  <script>
    // Get phone number from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('phone');

    // Function to check if resolution.json exists and is valid
    async function checkResolutionFile() {
      try {
        const response = await fetch('resolution.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('Raw response from resolution.json:', text.substring(0, 200) + '...');
        
        // Try to parse as JSON
        try {
          const data = JSON.parse(text);
          console.log('‚úÖ resolution.json parsed successfully');
          return data;
        } catch (parseError) {
          console.error('‚ùå resolution.json is not valid JSON:', parseError);
          console.log('First 500 chars of response:', text.substring(0, 500));
          return [];
        }
      } catch (error) {
        console.error('‚ùå Cannot load resolution.json:', error);
        return [];
      }
    }

    // Function to normalize phone numbers for comparison
    function normalizePhone(phone) {
      return phone.toString().trim().replace(/\D/g, ''); // Remove non-digits
    }

    // Function to find matching order for a complaint
    function findMatchingOrder(complaint, orders) {
      const complaintDate = new Date(complaint.date);
      
      // Try to find order on the same date
      return orders.find(order => {
        const orderDate = new Date(order['Created'] || '');
        return orderDate.toDateString() === complaintDate.toDateString();
      });
    }

    // Function to format currency
    function formatCurrency(amount) {
      return 'EGP ' + (amount || 0).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    if (!phone) {
      document.getElementById('customerInfo').innerHTML = '<div class="loading">No customer phone specified</div>';
      document.getElementById('complaintsList').innerHTML = '<div class="loading">No customer phone specified</div>';
    } else {
      // Load data from files
      Promise.all([
        fetch('data.json').then(r => r.json()),
        fetch('complaints.json').then(r => r.json()),
        checkResolutionFile() // Use our custom function to check resolution file
      ])
      .then(([dataRows, compRows, resolutionRows = []]) => {
        console.log('=== DATA LOADED ===');
        console.log('Orders:', dataRows.length);
        console.log('Complaints:', compRows.length);
        console.log('Resolutions:', resolutionRows.length);
        
        // Show all resolutions for debugging
        console.log('All resolution records:', resolutionRows);
        
        // Filter complaints for this customer
        const normalizedSearchPhone = normalizePhone(phone);
        const customerComplaints = compRows.filter(complaint => 
          normalizePhone(complaint.phone || '') === normalizedSearchPhone
        );

        console.log('=== CUSTOMER DATA ===');
        console.log('Customer complaints:', customerComplaints.length, customerComplaints);
        console.log('Searching for phone:', normalizedSearchPhone);

        // Get customer info from orders
        const customerOrders = dataRows.filter(order => 
          normalizePhone(order['Account Phones'] || '') === normalizedSearchPhone
        );
        const customerName = customerOrders[0]?.['Account Name'] || 'Unknown Customer';
        const totalOrders = customerOrders.length;
        const totalSpent = customerOrders.reduce((sum, order) => sum + (parseFloat(order['Total Price']) || 0), 0);

        // Update customer info with file status
        document.getElementById('customerInfo').innerHTML = `
          <h2>${customerName}</h2>
          <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Phone: ${phone}</p>
          <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <div>
              <strong>Total Orders:</strong> ${totalOrders}
            </div>
            <div>
              <strong>Total Spent:</strong> ${formatCurrency(totalSpent)}
            </div>
            <div>
              <strong>Total Complaints:</strong> ${customerComplaints.length}
            </div>
            <div>
              <strong>Resolutions File:</strong> 
              <span style="color: ${resolutionRows.length > 0 ? 'green' : 'red'}">
                ${resolutionRows.length > 0 ? '‚úÖ Loaded' : '‚ùå Not Found/Invalid'}
              </span>
            </div>
          </div>
          ${resolutionRows.length === 0 ? `
          <div style="margin-top: 1rem; padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">
            <strong>‚ö†Ô∏è Resolution File Issue:</strong><br>
            The resolution.json file could not be loaded. This could be because:<br>
            ‚Ä¢ The file doesn't exist<br>
            ‚Ä¢ The file contains invalid JSON<br>
            ‚Ä¢ The file path is incorrect<br>
            ‚Ä¢ The server returned an error page instead of JSON
          </div>
          ` : ''}
        `;

        // Update complaints list
        const complaintsList = document.getElementById('complaintsList');
        if (customerComplaints.length === 0) {
          complaintsList.innerHTML = '<div class="complaint-card"><div class="no-data">No complaints found for this customer</div></div>';
        } else {
          complaintsList.innerHTML = customerComplaints
            .sort((a, b) => new Date(b.date || '') - new Date(a.date || ''))
            .map(complaint => {
              const matchingOrder = findMatchingOrder(complaint, customerOrders);
              const complaintDate = new Date(complaint.date || '');
              
              return `
                <div class="complaint-card">
                  <div class="complaint-header">
                    <span class="complaint-category">${complaint.category || 'Uncategorized'}</span>
                    <span class="complaint-date">${complaintDate.toLocaleDateString()}</span>
                    <span class="status-badge status-pending">
                      Pending Resolution
                    </span>
                  </div>
                  
                  ${matchingOrder ? `
                  <div class="order-info">
                    <h3>üì¶ Related Order</h3>
                    <div class="order-details">
                      <div class="order-detail">
                        <span class="order-label">Order Date</span>
                        <span class="order-value">${new Date(matchingOrder['Created'] || '').toLocaleDateString()}</span>
                      </div>
                      <div class="order-detail">
                        <span class="order-label">Restaurant</span>
                        <span class="order-value">${matchingOrder['Resturant'] || matchingOrder['Restaurant'] || 'N/A'}</span>
                      </div>
                      <div class="order-detail">
                        <span class="order-label">Amount</span>
                        <span class="order-value">${formatCurrency(parseFloat(matchingOrder['Total Price']))}</span>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                  
                  <div class="complaint-details">
                    <h3>Complaint Details:</h3>
                    <div class="complaint-text">${complaint.details || complaint.complaint_details || 'No details provided'}</div>
                  </div>
                  
                  <div class="complaint-details">
                    <h3>Resolution Status:</h3>
                    <div class="complaint-text" style="background: #fef3c7; border-left-color: #f59e0b;">
                      ‚ö†Ô∏è Resolution data unavailable - resolution.json file could not be loaded
                    </div>
                  </div>
                  
                  ${complaint.follow_up || complaint.follow_up_actions ? `
                  <div class="complaint-details">
                    <h3>Follow-up Actions:</h3>
                    <div class="complaint-text">${complaint.follow_up || complaint.follow_up_actions}</div>
                  </div>
                  ` : ''}
                </div>
              `;
            }).join('');
        }
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('customerInfo').innerHTML = '<div class="loading">Error loading customer information</div>';
        document.getElementById('complaintsList').innerHTML = '<div class="loading">Error loading complaints</div>';
      });
    }

    // Add debug toggle (hold Ctrl+D to show debug info)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        const debugInfos = document.querySelectorAll('.debug-info');
        debugInfos.forEach(debug => {
          debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
