<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Complaint Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ... (keep all the same CSS styles) ... */
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
    <h1>Complaint Details</h1>
  </div>

  <div id="customerInfo" class="customer-info">
    <div class="loading">Loading customer information...</div>
  </div>

  <div id="debugInfo" style="display: none;"></div>

  <div class="complaints-container" id="complaintsList">
    <div class="loading">Loading complaints...</div>
  </div>

  <script>
    // Get phone number from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('phone');

    // Function to check if resolution.json exists and is valid
    async function checkResolutionFile() {
      try {
        const response = await fetch('resolution.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('Raw response from resolution.json:', text.substring(0, 200) + '...');
        
        // Try to parse as JSON
        try {
          const data = JSON.parse(text);
          console.log('‚úÖ resolution.json parsed successfully');
          return data;
        } catch (parseError) {
          console.error('‚ùå resolution.json is not valid JSON:', parseError);
          console.log('First 500 chars of response:', text.substring(0, 500));
          return [];
        }
      } catch (error) {
        console.error('‚ùå Cannot load resolution.json:', error);
        return [];
      }
    }

    // Function to normalize phone numbers for comparison
    function normalizePhone(phone) {
      return phone.toString().trim().replace(/\D/g, ''); // Remove non-digits
    }

    // Function to find matching order for a complaint
    function findMatchingOrder(complaint, orders) {
      const complaintDate = new Date(complaint.date);
      
      // Try to find order on the same date
      return orders.find(order => {
        const orderDate = new Date(order['Created'] || '');
        return orderDate.toDateString() === complaintDate.toDateString();
      });
    }

    // Function to find resolution for a complaint - UPDATED FOR YOUR JSON STRUCTURE
    function findResolution(complaint, resolutions) {
      const complaintPhone = normalizePhone(complaint.phone || '');
      const complaintDate = new Date(complaint.date);
      
      console.log(`Looking for resolution for phone: ${complaintPhone}, date: ${complaintDate.toDateString()}`);
      
      // Try to find matching resolution
      return resolutions.find(resolution => {
        const resolutionPhone = normalizePhone(resolution.phone || '');
        const resolutionDate = new Date(resolution.date || '');
        
        console.log(`Checking resolution - phone: ${resolutionPhone}, date: ${resolutionDate.toDateString()}`);
        
        // Match by phone number (since dates might not align perfectly)
        if (resolutionPhone === complaintPhone) {
          console.log('‚úÖ Phone match found for resolution!');
          return true;
        }
        
        return false;
      });
    }

    // Function to get resolution text from resolution object - UPDATED FOR YOUR FIELDS
    function getResolutionText(resolution) {
      if (!resolution) return null;
      
      console.log('Resolution object fields:', Object.keys(resolution));
      
      // Use your specific field names
      const resolutionText = resolution.Resolution || 
             resolution.resolution || 
             resolution.resolution_details || 
             null;
      
      console.log('Found resolution text:', resolutionText);
      return resolutionText;
    }

    // Function to get status from resolution - UPDATED FOR YOUR FIELDS
    function getStatus(resolution) {
      if (!resolution) return 'pending';
      
      return resolution.Status || 
             resolution.status || 
             'resolved'; // Default to resolved if resolution exists
    }

    // Function to get resolved by - UPDATED FOR YOUR FIELDS
    function getResolvedBy(resolution) {
      if (!resolution) return null;
      
      return resolution.Resolvedby || 
             resolution.resolved_by || 
             resolution.ResolvedBy ||
             null;
    }

    // Function to format currency
    function formatCurrency(amount) {
      return 'EGP ' + (amount || 0).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    if (!phone) {
      document.getElementById('customerInfo').innerHTML = '<div class="loading">No customer phone specified</div>';
      document.getElementById('complaintsList').innerHTML = '<div class="loading'>No customer phone specified</div>';
    } else {
      // Load data from files
      Promise.all([
        fetch('data.json').then(r => r.json()),
        fetch('complaints.json').then(r => r.json()),
        checkResolutionFile() // Use our custom function to check resolution file
      ])
      .then(([dataRows, compRows, resolutionRows = []]) => {
        console.log('=== DATA LOADED ===');
        console.log('Orders:', dataRows.length);
        console.log('Complaints:', compRows.length);
        console.log('Resolutions:', resolutionRows.length);
        
        // Show all resolutions for debugging
        console.log('All resolution records:', resolutionRows);
        
        // Filter complaints for this customer
        const normalizedSearchPhone = normalizePhone(phone);
        const customerComplaints = compRows.filter(complaint => 
          normalizePhone(complaint.phone || '') === normalizedSearchPhone
        );

        // Filter resolutions for this customer
        const customerResolutions = resolutionRows.filter(resolution => 
          normalizePhone(resolution.phone || '') === normalizedSearchPhone
        );

        console.log('=== CUSTOMER DATA ===');
        console.log('Customer complaints:', customerComplaints.length, customerComplaints);
        console.log('Customer resolutions:', customerResolutions.length, customerResolutions);
        console.log('Searching for phone:', normalizedSearchPhone);

        // Get customer info from orders
        const customerOrders = dataRows.filter(order => 
          normalizePhone(order['Account Phones'] || '') === normalizedSearchPhone
        );
        const customerName = customerOrders[0]?.['Account Name'] || 'Unknown Customer';
        const totalOrders = customerOrders.length;
        const totalSpent = customerOrders.reduce((sum, order) => sum + (parseFloat(order['Total Price']) || 0), 0);

        // Update customer info with file status
        document.getElementById('customerInfo').innerHTML = `
          <h2>${customerName}</h2>
          <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Phone: ${phone}</p>
          <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <div>
              <strong>Total Orders:</strong> ${totalOrders}
            </div>
            <div>
              <strong>Total Spent:</strong> ${formatCurrency(totalSpent)}
            </div>
            <div>
              <strong>Total Complaints:</strong> ${customerComplaints.length}
            </div>
            <div>
              <strong>Resolutions Found:</strong> ${customerResolutions.length}
            </div>
          </div>
          ${customerResolutions.length > 0 ? `
          <div style="margin-top: 1rem; padding: 1rem; background: #f0f8f7; border-radius: 8px;">
            <strong>‚úÖ Resolution Data Found!</strong><br>
            Found ${customerResolutions.length} resolution record(s) for this phone number.
          </div>
          ` : ''}
        `;

        // Update complaints list
        const complaintsList = document.getElementById('complaintsList');
        if (customerComplaints.length === 0) {
          complaintsList.innerHTML = '<div class="complaint-card"><div class="no-data">No complaints found for this customer</div></div>';
        } else {
          complaintsList.innerHTML = customerComplaints
            .sort((a, b) => new Date(b.date || '') - new Date(a.date || ''))
            .map(complaint => {
              const matchingOrder = findMatchingOrder(complaint, customerOrders);
              const matchingResolution = findResolution(complaint, resolutionRows);
              const complaintDate = new Date(complaint.date || '');
              const status = getStatus(matchingResolution);
              const resolutionText = getResolutionText(matchingResolution);
              const resolvedBy = getResolvedBy(matchingResolution);
              const hasResolution = resolutionText && resolutionText.trim().length > 0;
              
              console.log('=== COMPLAINT PROCESSING ===');
              console.log('Complaint:', complaint);
              console.log('Matching Resolution:', matchingResolution);
              console.log('Has Resolution:', hasResolution);
              console.log('Resolution Text:', resolutionText);

              return `
                <div class="complaint-card">
                  <div class="complaint-header">
                    <span class="complaint-category">${complaint.category || 'Uncategorized'}</span>
                    <span class="complaint-date">${complaintDate.toLocaleDateString()}</span>
                    <span class="status-badge ${status === 'resolved' || status === 'Resolved' ? 'status-resolved' : 'status-pending'}">
                      ${status === 'resolved' || status === 'Resolved' ? 'Resolved' : 'Pending'}
                    </span>
                  </div>
                  
                  ${matchingOrder ? `
                  <div class="order-info">
                    <h3>üì¶ Related Order</h3>
                    <div class="order-details">
                      <div class="order-detail">
                        <span class="order-label">Order Date</span>
                        <span class="order-value">${new Date(matchingOrder['Created'] || '').toLocaleDateString()}</span>
                      </div>
                      <div class="order-detail">
                        <span class="order-label">Restaurant</span>
                        <span class="order-value">${matchingOrder['Resturant'] || matchingOrder['Restaurant'] || 'N/A'}</span>
                      </div>
                      <div class="order-detail">
                        <span class="order-label">Amount</span>
                        <span class="order-value">${formatCurrency(parseFloat(matchingOrder['Total Price']))}</span>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                  
                  <div class="complaint-details">
                    <h3>Complaint Details:</h3>
                    <div class="complaint-text">${complaint.details || complaint.complaint_details || 'No details provided'}</div>
                  </div>
                  
                  ${hasResolution ? `
                  <div class="resolution-section">
                    <h4>‚úÖ Resolution</h4>
                    <div class="resolution-text">${resolutionText}</div>
                    ${matchingResolution && matchingResolution.date ? `
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #065f46;">
                      Resolution Date: ${new Date(matchingResolution.date).toLocaleDateString()}
                    </div>
                    ` : ''}
                    ${resolvedBy ? `
                    <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #065f46;">
                      Resolved by: ${resolvedBy}
                    </div>
                    ` : ''}
                    ${matchingResolution && matchingResolution.Resturant ? `
                    <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #065f46;">
                      Restaurant: ${matchingResolution.Resturant}
                    </div>
                    ` : ''}
                  </div>
                  ` : `
                  <div class="complaint-details">
                    <h3>Resolution Status:</h3>
                    <div class="complaint-text" style="background: #fef3c7; border-left-color: #f59e0b;">
                      ${matchingResolution ? 
                        'Resolution record found but no resolution text available.' : 
                        'No resolution record found for this complaint.'}
                    </div>
                  </div>
                  `}
                  
                  ${complaint.follow_up || complaint.follow_up_actions ? `
                  <div class="complaint-details">
                    <h3>Follow-up Actions:</h3>
                    <div class="complaint-text">${complaint.follow_up || complaint.follow_up_actions}</div>
                  </div>
                  ` : ''}

                  <!-- Debug information for this complaint -->
                  <div class="debug-info" style="display: none;">
                    <strong>Debug Info:</strong><br>
                    Complaint Phone: ${complaint.phone}<br>
                    Complaint Date: ${complaintDate.toDateString()}<br>
                    Has Matching Order: ${!!matchingOrder}<br>
                    Has Matching Resolution: ${!!matchingResolution}<br>
                    Resolution Object: ${JSON.stringify(matchingResolution)}<br>
                    Resolution Text: "${resolutionText}"<br>
                    Status: ${status}<br>
                    All Resolution Fields: ${matchingResolution ? Object.keys(matchingResolution).join(', ') : 'N/A'}
                  </div>
                </div>
              `;
            }).join('');
        }
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('customerInfo').innerHTML = '<div class="loading">Error loading customer information</div>';
        document.getElementById('complaintsList').innerHTML = '<div class="loading">Error loading complaints</div>';
      });
    }

    // Add debug toggle (hold Ctrl+D to show debug info)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        const debugInfos = document.querySelectorAll('.debug-info');
        debugInfos.forEach(debug => {
          debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
