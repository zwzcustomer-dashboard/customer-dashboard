<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Complaint Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:0;padding:1rem;background:#f5f7fa;color:#333}
    h2{margin-top:0}
    .badge{background:#e91e63;color:#fff;padding:.3rem .6rem;border-radius:4px;font-size:.9rem}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:2rem}
    th,td{padding:.6rem;text-align:left}
    th{background:#e91e63;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    .order-row{background:#e3f2fd;}
    .resolved{background:#c8e6c9;}
    .pending{background:#ffecb3;}
    h3{margin:1.5rem 0 .5rem 0;font-size:1.1rem}
    .error{color:#d32f2f;background:#ffcdd2;padding:1rem;border-radius:4px;margin:1rem 0}
    .status-badge{padding:0.25rem 0.5rem;border-radius:4px;font-size:0.8rem;font-weight:bold}
    .status-resolved{background:#4caf50;color:white}
    .status-pending{background:#ff9800;color:white}
  </style>
</head>
<body>
  <h2 id="title"></h2>
  <p id="summary"></p>

  <!-- Orders on complaint date(s) -->
  <h3>Order(s) on complaint date(s)</h3>
  <table id="orderTable">
    <thead><tr><th>Date</th><th>Restaurant</th><th>Payment</th><th>Amount</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Complaints -->
  <h3>Complaints</h3>
  <table id="complaintTable">
    <thead>
      <tr>
        <th>Date</th><th>Category</th><th>Complaint Details</th><th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Resolutions -->
  <h3>Resolutions</h3>
  <table id="resolutionTable">
    <thead>
      <tr>
        <th>Date</th><th>Resolved By</th><th>Resolution Details</th><th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
// Get phone number from URL parameter
const urlParams = new URLSearchParams(location.search);
const wanted = urlParams.get('phone')?.trim();

if (!wanted) {
  document.body.innerHTML = '<h2 class="error">No phone number supplied</h2><p>Please add ?phone=YOUR_PHONE_NUMBER to the URL</p>';
  throw new Error('No phone supplied');
}

// Display the phone number we're searching for
document.getElementById('title').textContent = `Complaints for ${wanted}`;

// Load all JSON files
Promise.all([
  fetch('complaints.json').then(r => {
    if (!r.ok) throw new Error(`Failed to load complaints.json: ${r.status}`);
    return r.json();
  }),
  fetch('data.json').then(r => {
    if (!r.ok) throw new Error(`Failed to load data.json: ${r.status}`);
    return r.json();
  }),
  fetch('resolutions.json').then(r => {
    if (!r.ok) throw new Error(`Failed to load resolutions.json: ${r.status}`);
    return r.json();
  })
]).then(([compRows, orderRows, resRows]) => {
  // Normalize data
  const complaints = compRows.map(c => ({
    ...c,
    phone: (c.phone || c.Phone || '').toString().trim(),
    date: c.date || c.Date || '',
    category: c.category || c.Category || '',
    details: c.details || c.Details || ''
  }));

  const orders = orderRows.map(o => ({
    ...o,
    phone: (o.phone || o.Phone || o['Account Phones'] || '').toString().trim(),
    restaurant: o.restaurant || o.Restaurant || o.Resturant || '',
    date: o.date || o.Date || o.Created || o.OrderDate || '',
    payment: o.payment || o.Payment || o['Payment Method'] || '',
    amount: o.amount || o.Amount || o['Total Price'] || 0
  }));

  const resolutions = resRows.map(r => ({
    ...r,
    phone: (r.phone || r.Phone || '').toString().trim(),
    date: r.date || r.Date || '',
    resolvedBy: r.resolvedBy || r['Resolved By'] || r.Resolvedby || '',
    resolution: r.resolution || r.Resolution || r.action || r.Action || r['Action Taken'] || '',
    status: r.status || r.Status || ''
  }));

  // Filter complaints for the wanted phone number
  const filteredComplaints = complaints.filter(c => c.phone === wanted);

  if (!filteredComplaints.length) {
    document.body.innerHTML = `<h2 class="error">No complaints found for phone ${wanted}</h2>`;
    return;
  }

  document.getElementById('summary').textContent = `Total complaints: ${filteredComplaints.length}`;

  /* ---- ORDERS ON COMPLAINT DATE(S) ---- */
  const complaintDates = [...new Set(filteredComplaints.map(c => {
    const date = new Date(c.date);
    return isNaN(date) ? null : date.toDateString();
  }).filter(Boolean))];

  const matchedOrders = orders.filter(o => {
    if (o.phone !== wanted) return false;
    
    const orderDate = new Date(o.date);
    if (isNaN(orderDate)) return false;
    
    return complaintDates.includes(orderDate.toDateString());
  });

  const orderTableBody = document.querySelector('#orderTable tbody');
  if (matchedOrders.length) {
    matchedOrders.sort((a, b) => new Date(a.date) - new Date(b.date));
    matchedOrders.forEach(order => {
      const row = document.createElement('tr');
      row.className = 'order-row';
      
      const orderDate = new Date(order.date);
      const dateString = isNaN(orderDate) ? 'Invalid Date' : orderDate.toLocaleDateString();
      const amount = parseFloat(order.amount) || 0;
      
      row.innerHTML = `
        <td>${dateString}</td>
        <td>${order.restaurant || 'N/A'}</td>
        <td>${order.payment || 'N/A'}</td>
        <td>${amount.toFixed(2)}</td>
      `;
      orderTableBody.appendChild(row);
    });
  } else {
    orderTableBody.innerHTML = '<tr><td colspan="4">No orders found on complaint date(s)</td></tr>';
  }

  /* ---- COMPLAINTS TABLE ---- */
  const complaintTableBody = document.querySelector('#complaintTable tbody');
  
  filteredComplaints.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  filteredComplaints.forEach(complaint => {
    const complaintDate = new Date(complaint.date);
    const complaintDateStr = isNaN(complaintDate) ? '' : complaintDate.toDateString();
    
    // Find matching resolution to determine status
    const resolution = resolutions.find(r => {
      if (r.phone !== wanted) return false;
      
      const resolutionDate = new Date(r.date);
      if (isNaN(resolutionDate)) return false;
      
      return resolutionDate.toDateString() === complaintDateStr;
    }) || {};

    const row = document.createElement('tr');
    
    // Apply status-based styling
    if (resolution.status === 'Resolved') {
      row.className = 'resolved';
    } else if (!resolution.status) {
      row.className = 'pending';
    }

    const displayDate = isNaN(complaintDate) ? 'Invalid Date' : complaintDate.toLocaleDateString();
    const statusClass = resolution.status === 'Resolved' ? 'status-resolved' : 'status-pending';
    const statusText = resolution.status || 'Pending';
    
    row.innerHTML = `
      <td>${displayDate}</td>
      <td>${complaint.category || 'N/A'}</td>
      <td>${complaint.details || 'N/A'}</td>
      <td><span class="status-badge ${statusClass}">${statusText}</span></td>
    `;
    
    complaintTableBody.appendChild(row);
  });

  /* ---- RESOLUTIONS TABLE ---- */
  const resolutionTableBody = document.querySelector('#resolutionTable tbody');
  
  // Filter resolutions for this phone number
  const filteredResolutions = resolutions.filter(r => r.phone === wanted);
  
  if (filteredResolutions.length) {
    filteredResolutions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    filteredResolutions.forEach(resolution => {
      const row = document.createElement('tr');
      
      const resolutionDate = new Date(resolution.date);
      const displayDate = isNaN(resolutionDate) ? 'Invalid Date' : resolutionDate.toLocaleDateString();
      const statusClass = resolution.status === 'Resolved' ? 'status-resolved' : 'status-pending';
      
      row.innerHTML = `
        <td>${displayDate}</td>
        <td>${resolution.resolvedBy || '—'}</td>
        <td>${resolution.resolution || '—'}</td>
        <td><span class="status-badge ${statusClass}">${resolution.status || 'Pending'}</span></td>
      `;
      
      resolutionTableBody.appendChild(row);
    });
  } else {
    resolutionTableBody.innerHTML = '<tr><td colspan="4">No resolutions found</td></tr>';
  }

}).catch(error => {
  console.error('Error:', error);
  document.body.innerHTML = `<h2 class="error">Error loading data</h2><p>Check browser console for details.</p>`;
});
</script>
</body>
</html>
